{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/milaa/Documents/professorlist/web/app/api/scrape/route.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { Department } from \"@/types/professor\";\r\nimport { createGoogleGenerativeAI } from \"@ai-sdk/google\";\r\nimport { createOpenAI } from \"@ai-sdk/openai\";\r\nimport { generateObject } from \"ai\";\r\nimport { z } from \"zod\";\r\n\r\n// Map departments to their URL\r\nconst DEPARTMENT_URLS: Record<Department, string> = {\r\n    \"Artificial Intelligence\": \"https://www.aibe.tf.fau.de/team/members/\",\r\n    \"Chemical and Biological Engineering\": \"https://www.cbi.tf.fau.de/department/lehrstuehle-und-professuren/\",\r\n    \"Electrical Engineering\": \"https://www.ee.tf.fau.de/department/lehrstuehle/\",\r\n    \"Computer Science\": \"https://www.fau.de/department/informatik/lehrstuehle/\",\r\n    \"Mechanical Engineering\": \"https://www.department.mb.tf.fau.de/department-maschinenbau/lehrstuehle-und-professuren/\",\r\n    \"Materials Science\": \"https://www.mat.tf.fau.de/department/lehrstuehle/\",\r\n};\r\n\r\n// Schema for a single professor\r\nconst SingleProfessorSchema = z.object({\r\n    name: z.string(),\r\n    department: z.string(),\r\n    email: z.string().optional(),\r\n    website: z.string().optional(),\r\n    research_interests: z.array(z.string()),\r\n    bio_summary: z.string().optional(),\r\n    relevance_score: z.number().optional().describe(\"Score 0-10 based on user interests\"),\r\n    citations: z.number().optional(),\r\n    publications: z.number().optional(),\r\n    h_index: z.number().optional(),\r\n});\r\n\r\n// Schema for the full list\r\nconst ProfessorListSchema = z.object({\r\n    professors: z.array(\r\n        z.object({\r\n            name: z.string(),\r\n            department: z.string(),\r\n        })\r\n    ),\r\n});\r\n\r\nfunction sendEvent(controller: ReadableStreamDefaultController, event: string, data: any) {\r\n    const message = `data: ${JSON.stringify({ event, data, timestamp: new Date().toISOString() })}\\n\\n`;\r\n    controller.enqueue(new TextEncoder().encode(message));\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n    const { departments, apiKey, provider, userInterests, ollamaModel, enrichExternal } = await req.json();\r\n\r\n    // Validation\r\n    if (!departments || departments.length === 0 || (!apiKey && provider !== \"ollama\")) {\r\n        return new Response(JSON.stringify({ error: \"Missing required fields\" }), {\r\n            status: 400,\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n        });\r\n    }\r\n\r\n    if (provider === \"ollama\" && !ollamaModel) {\r\n        return new Response(JSON.stringify({ error: \"Ollama model must be selected\" }), {\r\n            status: 400,\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n        });\r\n    }\r\n\r\n    // Create streaming response\r\n    const stream = new ReadableStream({\r\n        async start(controller) {\r\n            try {\r\n                // 1. Scrape all departments concurrently\r\n                sendEvent(controller, \"progress\", { stage: \"scraping\", message: `Scraping ${departments.length} department(s)...` });\r\n\r\n                const browser = await puppeteer.launch({ headless: true });\r\n\r\n                const scrapingPromises = departments.map(async (department: Department, index: number) => {\r\n                    sendEvent(controller, \"progress\", {\r\n                        stage: \"scraping\",\r\n                        message: `Scraping ${department}... (${index + 1}/${departments.length})`\r\n                    });\r\n\r\n                    const page = await browser.newPage();\r\n                    const url = DEPARTMENT_URLS[department];\r\n\r\n                    await page.setUserAgent(\r\n                        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\"\r\n                    );\r\n\r\n                    await page.goto(url, { waitUntil: \"networkidle2\", timeout: 60000 });\r\n\r\n                    const content = await page.evaluate(() => {\r\n                        const scripts = document.querySelectorAll('script, style, nav, footer, header');\r\n                        scripts.forEach(script => script.remove());\r\n                        return document.body.innerText;\r\n                    });\r\n\r\n                    await page.close();\r\n\r\n                    return { department, content: content.substring(0, 50000) };\r\n                });\r\n\r\n                const scrapedData = await Promise.all(scrapingPromises);\r\n                await browser.close();\r\n\r\n                // Merge all scraped content\r\n                const mergedContent = scrapedData.map(d => `=== ${d.department} ===\\n${d.content}`).join(\"\\n\\n\");\r\n\r\n                sendEvent(controller, \"progress\", {\r\n                    stage: \"scraped\",\r\n                    message: `Successfully scraped ${departments.length} department(s)`,\r\n                });\r\n\r\n                // 2. Extract professor names first\r\n                sendEvent(controller, \"progress\", { stage: \"parsing\", message: \"Extracting professor list...\" });\r\n\r\n                let model;\r\n                if (provider === \"gemini\") {\r\n                    const google = createGoogleGenerativeAI({ apiKey });\r\n                    model = google(\"models/gemini-1.5-flash-latest\");\r\n                } else if (provider === \"groq\") {\r\n                    const groq = createOpenAI({\r\n                        baseURL: 'https://api.groq.com/openai/v1',\r\n                        apiKey,\r\n                    });\r\n                    model = groq(\"llama-3.3-70b-versatile\");\r\n                } else if (provider === \"ollama\") {\r\n                    const ollama = createOpenAI({\r\n                        baseURL: 'http://localhost:11434/v1',\r\n                        apiKey: 'ollama',\r\n                        fetch: (url, options) => {\r\n                            return fetch(url, {\r\n                                ...options,\r\n                                signal: AbortSignal.timeout(300000),\r\n                            });\r\n                        },\r\n                    });\r\n                    model = ollama(ollamaModel);\r\n                }\r\n\r\n                const listResult = await generateObject({\r\n                    model,\r\n                    schema: ProfessorListSchema,\r\n                    prompt: `Extract a list of professor names and their departments from this text. Just names and departments.\\n\\n${mergedContent}`,\r\n                });\r\n\r\n                const professorList = listResult.object.professors;\r\n\r\n                // Deduplicate professors by name\r\n                const uniqueProfessors = Array.from(\r\n                    new Map(professorList.map(p => [p.name.toLowerCase(), p])).values()\r\n                );\r\n\r\n                sendEvent(controller, \"progress\", {\r\n                    stage: \"parsed\",\r\n                    message: `Found ${uniqueProfessors.length} unique professors`,\r\n                });\r\n\r\n                // Send the raw list\r\n                sendEvent(controller, \"professors_list\", { professors: uniqueProfessors });\r\n\r\n                // 3. Analyze each professor\r\n                for (let i = 0; i < uniqueProfessors.length; i++) {\r\n                    const prof = uniqueProfessors[i];\r\n                    sendEvent(controller, \"progress\", {\r\n                        stage: \"analyzing\",\r\n                        message: `Analyzing ${prof.name}... (${i + 1}/${uniqueProfessors.length})`,\r\n                        current: i,\r\n                        total: uniqueProfessors.length,\r\n                    });\r\n\r\n                    try {\r\n                        const detailPrompt = `\r\nYou are analyzing a professor from a university website.\r\n\r\nProfessor: ${prof.name}\r\nDepartment: ${prof.department}\r\n\r\nFrom the following text, extract ONLY information about this specific professor:\r\n- Email (if available)\r\n- Website URL (if available)\r\n- Research Interests (as a list of 3-5 tags)\r\n- A brief 1-sentence bio summary\r\n\r\n${userInterests ? `\r\nCRITICAL: The user is looking for a supervisor with these interests: \"${userInterests}\".\r\nRate this professor from 0-10 on relevance to these interests.\r\n` : `Set 'relevance_score' to 0.`}\r\n\r\nText Content:\r\n${mergedContent}\r\n                        `;\r\n\r\n                        const detailResult = await generateObject({\r\n                            model,\r\n                            schema: SingleProfessorSchema,\r\n                            prompt: detailPrompt,\r\n                        });\r\n\r\n                        let professor = detailResult.object;\r\n\r\n                        // TODO: External enrichment will go here\r\n                        if (enrichExternal) {\r\n                            sendEvent(controller, \"progress\", {\r\n                                stage: \"analyzing\",\r\n                                message: `Enriching ${prof.name} with external data...`,\r\n                            });\r\n                            // Add 2s delay to show it's working\r\n                            await new Promise(resolve => setTimeout(resolve, 2000));\r\n                            // Placeholder: add mock data for now\r\n                            professor.citations = Math.floor(Math.random() * 5000);\r\n                            professor.publications = Math.floor(Math.random() * 100);\r\n                            professor.h_index = Math.floor(Math.random() * 50);\r\n                        }\r\n\r\n                        sendEvent(controller, \"professor_analyzed\", { professor, index: i });\r\n                    } catch (err) {\r\n                        console.error(`Error analyzing professor ${prof.name}:`, err);\r\n                        sendEvent(controller, \"professor_analyzed\", {\r\n                            professor: { ...prof, research_interests: [], relevance_score: 0 },\r\n                            index: i,\r\n                        });\r\n                    }\r\n                }\r\n\r\n                sendEvent(controller, \"progress\", {\r\n                    stage: \"complete\",\r\n                    message: `âœ¨ Analysis complete! Processed ${uniqueProfessors.length} professors.`,\r\n                });\r\n\r\n                controller.close();\r\n            } catch (error: any) {\r\n                console.error(\"Processing error:\", error);\r\n                sendEvent(controller, \"error\", { message: error.message });\r\n                controller.close();\r\n            }\r\n        },\r\n    });\r\n\r\n    return new Response(stream, {\r\n        headers: {\r\n            \"Content-Type\": \"text/event-stream\",\r\n            \"Cache-Control\": \"no-cache\",\r\n            \"Connection\": \"keep-alive\",\r\n        },\r\n    });\r\n}\r\n"],"names":[],"mappings":"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"}}]
}