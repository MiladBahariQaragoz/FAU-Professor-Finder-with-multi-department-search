{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 42, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/milaa/Documents/professorlist/web/app/api/scrape/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { Department } from \"@/types/professor\";\r\nimport { createGoogleGenerativeAI } from \"@ai-sdk/google\";\r\nimport { createOpenAI } from \"@ai-sdk/openai\";\r\nimport { generateObject } from \"ai\";\r\nimport { z } from \"zod\";\r\n\r\n// Map departments to their URL\r\nconst DEPARTMENT_URLS: Record<Department, string> = {\r\n    \"Artificial Intelligence\": \"https://www.aibe.tf.fau.de/team/members/\",\r\n    \"Chemical and Biological Engineering\": \"https://www.cbi.tf.fau.de/department/lehrstuehle-und-professuren/\",\r\n    \"Electrical Engineering\": \"https://www.ee.tf.fau.de/department/lehrstuehle/\",\r\n    \"Computer Science\": \"https://www.fau.de/department/informatik/lehrstuehle/\",\r\n    \"Mechanical Engineering\": \"https://www.department.mb.tf.fau.de/department-maschinenbau/lehrstuehle-und-professuren/\",\r\n    \"Materials Science\": \"https://www.mat.tf.fau.de/department/lehrstuehle/\",\r\n};\r\n\r\n// Zod schema for the output\r\nconst ProfessorSchema = z.object({\r\n    professors: z.array(\r\n        z.object({\r\n            name: z.string(),\r\n            department: z.string(),\r\n            email: z.string().optional(),\r\n            website: z.string().optional(),\r\n            research_interests: z.array(z.string()),\r\n            bio_summary: z.string().optional(),\r\n            relevance_score: z.number().optional().describe(\"Score 0-10 based on user interests\"),\r\n        })\r\n    ),\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { department, apiKey, provider, userInterests, ollamaModel } = await req.json();\r\n\r\n        if (!department || (!apiKey && provider !== \"ollama\")) {\r\n            return NextResponse.json(\r\n                { error: \"Missing required fields\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        if (provider === \"ollama\" && !ollamaModel) {\r\n            return NextResponse.json(\r\n                { error: \"Ollama model must be selected\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const url = DEPARTMENT_URLS[department as Department];\r\n        if (!url) {\r\n            return NextResponse.json({ error: \"Invalid department\" }, { status: 400 });\r\n        }\r\n\r\n        // 1. Scrape the website\r\n        let content = \"\";\r\n        try {\r\n            const browser = await puppeteer.launch({ headless: true });\r\n            const page = await browser.newPage();\r\n\r\n            await page.setUserAgent(\r\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36\"\r\n            );\r\n\r\n            await page.goto(url, { waitUntil: \"networkidle2\", timeout: 60000 });\r\n\r\n            content = await page.evaluate(() => {\r\n                const scripts = document.querySelectorAll('script, style, nav, footer, header');\r\n                scripts.forEach(script => script.remove());\r\n                return document.body.innerText;\r\n            });\r\n\r\n            // Truncate content if too long to avoid token limits (rough heuristic)\r\n            if (content.length > 50000) content = content.substring(0, 50000);\r\n\r\n            await browser.close();\r\n        } catch (scrapeError) {\r\n            console.error(\"Scraping failed:\", scrapeError);\r\n            return NextResponse.json({ error: \"Failed to scrape content. The department website might be unreachable.\" }, { status: 502 });\r\n        }\r\n\r\n        // 2. Process with LLM\r\n        let model;\r\n\r\n        if (provider === \"gemini\") {\r\n            const google = createGoogleGenerativeAI({ apiKey });\r\n            model = google(\"models/gemini-1.5-flash-latest\");\r\n        } else if (provider === \"groq\") {\r\n            const groq = createOpenAI({\r\n                baseURL: 'https://api.groq.com/openai/v1',\r\n                apiKey,\r\n            });\r\n            model = groq(\"llama-3.3-70b-versatile\");\r\n        } else if (provider === \"ollama\") {\r\n            const ollama = createOpenAI({\r\n                baseURL: 'http://localhost:11434/v1',\r\n                apiKey: 'ollama', // Ollama doesn't need a real API key\r\n            });\r\n            model = ollama(ollamaModel);\r\n        } else {\r\n            return NextResponse.json(\r\n                { error: \"Invalid provider\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const prompt = `\r\n      You are an expert academic recruiter.\r\n      Extract a list of professors from the following text scraped from a university department page.\r\n      \r\n      Department: ${department}\r\n      URL: ${url}\r\n      \r\n      For each professor, extract:\r\n      - Name\r\n      - Specific Department/Chair (if mentioned)\r\n      - Email (if available)\r\n      - Website URL (if available)\r\n      - Research Interests (as a list of 3-5 tags, e.g., \"Deep Learning\", \"Robotics\")\r\n      - A brief 1-sentence bio summary based on the text.\r\n      \r\n      ${userInterests ? `\r\n      CRITICAL: The user is looking for a supervisor with these interests: \"${userInterests}\".\r\n      Rate each professor from 0-10 on relevance to these interests in the 'relevance_score' field.\r\n      If the professor is highly relevant, ensure their research tags reflect that match.\r\n      ` : `\r\n      Set 'relevance_score' to 0 for all.\r\n      `}\r\n\r\n      Text Content:\r\n      ${content}\r\n    `;\r\n\r\n        const result = await generateObject({\r\n            model,\r\n            schema: ProfessorSchema,\r\n            prompt,\r\n        });\r\n\r\n        return NextResponse.json({ professors: result.object.professors });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Processing error:\", error);\r\n        return NextResponse.json(\r\n            { error: error.message || \"Failed to process request\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}